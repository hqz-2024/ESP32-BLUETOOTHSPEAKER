# ESP32 蓝牙A2DP音箱程序

## 项目概述

这是一个基于ESP32的蓝牙A2DP音频接收器项目，使用纯A2DP库实现，**不依赖AudioTools库**。支持将手机或其他蓝牙设备的音频通过I2S输出到PCM5102 DAC芯片。

## 重要说明

⚠️ **此程序仅适用于ESP32经典版本，不支持ESP32-S3！**

ESP32-S3不支持经典蓝牙A2DP协议，只支持BLE（低功耗蓝牙）。

## 功能特性

### 核心功能
1. ✅ **蓝牙A2DP接收器** - 设备名称：ESP-AI-SPEAKER
2. ✅ **I2S音频输出** - 支持PCM5102 DAC芯片
3. ✅ **音量控制** - IO34 ADC电位器音量控制
4. ✅ **自动重连** - 保存配对信息，重启后自动重连
5. ✅ **恢复出厂设置** - IO0按钮连按5下清除配对数据
6. ✅ **低延时高音质** - 44.1kHz采样率，16位立体声

### 技术实现
- **纯A2DP库实现** - 不使用arduino-audio-tools库
- **直接I2S驱动** - 使用ESP-IDF的I2S驱动
- **音量混合控制** - 实际音量 = 手机音量 × 电位器音量
- **配对信息持久化** - 使用Preferences存储

## 硬件连接

### PCM5102 DAC模块连接

| PCM5102引脚 | ESP32引脚 | 说明 |
|------------|----------|------|
| VIN | 3.3V | 电源 |
| GND | GND | 地 |
| BCK | GPIO33 | I2S位时钟 |
| LRCK (WS) | GPIO26 | I2S左右声道时钟 |
| DIN | GPIO25 | I2S数据输入 |
| SCK | GND | 主时钟（不使用，接地） |
| MUTE | GPIO27 | 静音控制（可选） |

### 其他连接

| 功能 | ESP32引脚 | 说明 |
|------|----------|------|
| BOOT按钮 | GPIO0 | 连按5下恢复出厂设置 |
| 音量控制 | GPIO34 | ADC输入，连接电位器 |

### 音量控制电路（可选）

```
3.3V ----[10kΩ电位器]---- GPIO34 ----[10kΩ下拉]---- GND
```

## 使用方法

### 首次使用

1. **上传程序** - 将程序上传到ESP32
2. **打开串口监视器** - 波特率115200，查看启动信息
3. **搜索蓝牙设备** - 在手机上搜索"ESP-AI-SPEAKER"
4. **连接配对** - 点击连接，配对成功后自动保存
5. **播放音乐** - 播放手机音乐，音频将从PCM5102输出

### 音量控制

- **手机音量** - 调节手机的媒体音量
- **电位器音量** - 旋转连接到GPIO34的电位器
- **实际输出音量** = 手机音量 × 电位器音量

### 恢复出厂设置

1. 快速连续按下BOOT按钮（GPIO0）**5次**
2. 串口会显示"检测到5次点击，执行恢复出厂设置..."
3. 设备将清除所有配对信息并重启
4. 重启后进入配对模式，可以连接新设备

### 自动重连

- 设备会记住最后连接的蓝牙设备
- 重启后自动尝试重连该设备
- 如果设备不在范围内，会保持可发现状态等待连接

## 依赖库

需要安装以下Arduino库：

1. **ESP32-A2DP** - 蓝牙A2DP协议库
   - 作者: Phil Schatzmann
   - 位置: `libraries2/ESP32-A2DP-main`

2. **OneButton** - 按钮处理库
   - 位置: `libraries2/OneButton`

3. **Preferences** - ESP32内置，无需安装

## 编译配置

### Arduino IDE设置

- **开发板**: ESP32 Dev Module
- **Flash Size**: 4MB (32Mb)
- **Partition Scheme**: Default 4MB with spiffs
- **Core Debug Level**: Info（调试时）或None（发布时）

### PlatformIO配置

```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
lib_deps = 
    pschatzmann/ESP32-A2DP
    mathertel/OneButton
```

## 串口输出示例

```
ESP32 蓝牙A2DP音箱启动中...
版本：纯A2DP库实现，不使用AudioTools
PCM5102 I2S配置完成
PCM5102音箱已启动
蓝牙设备名称: ESP-AI-SPEAKER
自动重连已启用
等待蓝牙连接...
A2DP连接状态变化: 已连接
蓝牙设备已连接，保存配对信息
蓝牙配置已保存
A2DP audio state: Started
音量调整: 0.75 (ADC: 3072)
```

## 技术细节

### I2S配置

- **采样率**: 44100 Hz
- **位深度**: 16位
- **声道**: 立体声
- **DMA缓冲**: 8个缓冲区，每个512字节
- **时钟源**: 内部PLL（不使用APLL）

### 音频处理流程

1. **蓝牙接收** - A2DP接收SBC编码的音频数据
2. **SBC解码** - A2DP库自动解码为PCM数据
3. **音量调整** - 应用电位器音量系数
4. **I2S输出** - 通过I2S发送到PCM5102

### 内存优化

- 使用动态内存分配处理音频缓冲
- 及时释放临时缓冲区
- DMA缓冲区大小优化以平衡延迟和稳定性

## 故障排除

### 无声音输出

1. 检查PCM5102连接是否正确
2. 确认MUTE引脚为高电平（或悬空）
3. 检查I2S引脚定义是否匹配硬件
4. 查看串口是否显示"A2DP audio state: Started"

### 无法连接蓝牙

1. 确认使用的是ESP32经典版本（非S3）
2. 检查是否有其他设备已连接
3. 尝试恢复出厂设置清除配对信息
4. 重启ESP32和手机蓝牙

### 音质问题

1. 检查电源是否稳定（建议使用独立电源）
2. 确认I2S信号线不要太长
3. 在PCM5102和ESP32之间添加去耦电容
4. 检查音量是否过大导致失真

### 自动重连失败

1. 确认手机蓝牙已开启
2. 检查手机是否已删除配对信息
3. 尝试手动重新配对
4. 查看串口日志了解重连状态

## 代码结构

```
ESP32-A2DP-SPEAKER.INO
├── 引脚定义 (43-49行)
├── 全局对象和变量 (51-64行)
├── I2S配置 (66-102行)
├── 音频数据处理 (104-129行)
├── 蓝牙状态回调 (131-153行)
├── 音量控制 (155-164行)
├── 按钮处理 (166-193行)
├── 恢复出厂设置 (195-239行)
├── 配置保存/加载 (241-254行)
├── setup()初始化 (256-291行)
└── loop()主循环 (293-316行)
```

## 版本历史

### v2.0 (2024)
- 重写为纯A2DP库实现
- 移除AudioTools库依赖
- 优化音量控制算法
- 改进自动重连机制
- 完善恢复出厂设置功能

### v1.0 (2024)
- 初始版本
- 使用AudioTools库

## 许可证

本项目遵循开源许可证，具体请参考项目根目录的LICENSE文件。

## 作者

ESP-AI Team

## 参考资料

- [ESP32-A2DP库文档](https://github.com/pschatzmann/ESP32-A2DP)
- [ESP32 I2S驱动文档](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2s.html)
- [PCM5102数据手册](https://www.ti.com/product/PCM5102)

