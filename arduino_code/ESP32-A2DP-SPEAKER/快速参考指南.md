# ESP32 A2DP音箱快速参考指南

## 文件结构速查

```
ESP32-A2DP-SPEAKER/
├── ESP32-A2DP-SPEAKER.INO          # 主程序（113行）
├── src/                             # 模块目录
│   ├── userconfig.h                 # 硬件配置（修改这里适配硬件）
│   ├── audio_i2s.h/cpp              # I2S音频处理
│   ├── bluetooth_manager.h/cpp      # 蓝牙管理
│   ├── volume_control.h/cpp         # 音量控制
│   ├── led_control.h/cpp            # LED控制
│   ├── button_handler.h/cpp         # 按钮处理
│   ├── config_manager.h/cpp         # 配置管理
│   └── README.md                    # 模块说明文档
├── 模块化重构说明.md                 # 重构详细说明
└── 快速参考指南.md                   # 本文件
```

## 常用修改场景

### 场景1：更改引脚定义
**文件：** `src/userconfig.h`

```cpp
// I2S音频输出引脚
#define I2S_BCK_PIN     33    // 修改这里
#define I2S_LRCK_PIN    26    // 修改这里
#define I2S_DIN_PIN     25    // 修改这里
#define I2S_MUTE_PIN    27    // 修改这里

// 控制引脚
#define BOOT_BUTTON_PIN 0     // 修改这里
#define VOLUME_ADC_PIN  34    // 修改这里
#define WS2812_PIN      12    // 修改这里
```

### 场景2：更改蓝牙设备名称
**文件：** `src/userconfig.h`

```cpp
#define BT_DEVICE_NAME  "ESP-AI-SPEAKER"  // 修改这里
```

### 场景3：调整默认音量
**文件：** `src/userconfig.h`

```cpp
#define DEFAULT_VOLUME  0.8   // 修改这里（0.0-1.0）
```

### 场景4：调整LED亮度
**文件：** `src/userconfig.h`

```cpp
#define LED_BRIGHTNESS  100   // 修改这里（0-255）
```

### 场景5：更改恢复出厂设置的点击次数
**文件：** `src/userconfig.h`

```cpp
#define FACTORY_RESET_CLICKS  5   // 修改这里
```

### 场景6：调整音量档位数
**文件：** `src/userconfig.h`

```cpp
#define VOLUME_QUANTIZE_STEPS  20   // 修改这里（档位数）
```

### 场景7：修改LED颜色
**文件：** `src/userconfig.h`

```cpp
// RGB颜色值 (R, G, B)
#define LED_COLOR_BLUE    0, 0, 255    // 修改这里
#define LED_COLOR_GREEN   0, 255, 0    // 修改这里
```

## 模块API速查

### audio_i2s 模块
```cpp
void setupI2S();                          // 初始化I2S
void read_data_stream(data, length);      // 音频数据处理（回调）
void setAudioVolume(float volume);        // 设置音量
float getAudioVolume();                   // 获取音量
```

### bluetooth_manager 模块
```cpp
void initBluetooth(const char* name);     // 初始化蓝牙
BluetoothA2DPSink* getA2DPSink();        // 获取A2DP对象
bool isBluetoothConnected();              // 是否已连接
bool isAudioPlaying();                    // 是否播放中
void factoryReset();                      // 恢复出厂设置
```

### volume_control 模块
```cpp
void initVolumeControl();                 // 初始化音量控制
void updateVolume();                      // 更新音量（循环调用）
float getCurrentVolume();                 // 获取当前音量
```

### led_control 模块
```cpp
void initLedControl();                    // 初始化LED
void updateRgbLed(bool connected,         // 更新LED状态
                  bool playing);
```

### button_handler 模块
```cpp
void initButtonHandler();                 // 初始化按钮
void updateButton();                      // 更新按钮（循环调用）
void checkMultiClickTimeout();            // 检查多击超时
```

### config_manager 模块
```cpp
void saveBluetoothConfig();               // 保存配置
bool loadBluetoothConfig();               // 加载配置
void clearBluetoothConfig();              // 清除配置
```

## LED状态指示

| 状态 | LED显示 | 说明 |
|------|---------|------|
| 未连接 | 蓝色闪烁（1秒间隔） | 等待蓝牙连接 |
| 已连接未播放 | 蓝色长亮 | 已连接但未播放音乐 |
| 播放中 | 绿色呼吸灯 | 正在播放音乐 |

## 按钮功能

| 操作 | 功能 |
|------|------|
| 连按5下 | 恢复出厂设置（清除配对） |

## 音量控制

- **输入：** GPIO34 ADC（0-4095）
- **输出：** 0.0-1.0（21档位）
- **分辨率：** 0.05
- **更新间隔：** 300ms

## 常见问题

### Q1: 如何适配其他DAC芯片？
**A:** 修改 `src/userconfig.h` 中的I2S引脚定义，如果需要MCLK，修改 `src/audio_i2s.cpp` 中的I2S配置。

### Q2: 如何禁用LED功能？
**A:** 在主程序中注释掉 `initLedControl()` 和 `updateRgbLed()` 调用。

### Q3: 如何禁用音量控制？
**A:** 在主程序中注释掉 `initVolumeControl()` 和 `updateVolume()` 调用。

### Q4: 如何更改采样率？
**A:** 修改 `src/userconfig.h` 中的 `I2S_SAMPLE_RATE` 定义。

### Q5: 如何添加新功能？
**A:** 
1. 在src目录创建新模块（.h和.cpp文件）
2. 在主程序中包含新模块头文件
3. 在setup()中初始化新模块
4. 在loop()中调用新模块的更新函数

### Q6: 编译错误怎么办？
**A:** 
1. 确保所有依赖库已安装（ESP32-A2DP, OneButton, Adafruit_NeoPixel）
2. 检查Arduino IDE选择的开发板是否为ESP32
3. 确保所有模块文件都在src目录下

## 依赖库安装

### Arduino IDE
1. 打开 工具 -> 管理库
2. 搜索并安装以下库：
   - ESP32-A2DP by Phil Schatzmann
   - OneButton by Matthias Hertel
   - Adafruit NeoPixel

### PlatformIO
在 `platformio.ini` 中添加：
```ini
lib_deps = 
    https://github.com/pschatzmann/ESP32-A2DP
    mathertel/OneButton
    adafruit/Adafruit NeoPixel
```

## 调试技巧

### 1. 查看串口输出
- 波特率：115200
- 启动时会显示初始化信息
- 每10秒打印一次状态信息

### 2. 检查蓝牙连接
```
状态 - 连接: 已连接, 播放: 播放中, 音量: 0.80, 重连状态: 空闲
```

### 3. 音量调试
修改音量时会输出：
```
音量调整: 0.75 (ADC: 3072, 档位: 15/20)
```

### 4. 按钮调试
点击按钮时会输出：
```
按钮点击次数: 1
按钮点击次数: 2
...
```

## 性能参数

- **音频延迟：** < 100ms
- **采样率：** 44.1kHz
- **位深度：** 16bit
- **声道：** 立体声
- **DMA缓冲：** 8 x 512字节
- **音量档位：** 21档（0-20）
- **LED更新：** 30ms（呼吸灯）/ 1000ms（闪烁）
- **音量更新：** 300ms
- **状态打印：** 10秒

## 内存使用

- **Flash：** 约1.2MB（包含蓝牙库）
- **RAM：** 约80KB（运行时）
- **PSRAM：** 不需要

## 支持的ESP32型号

✅ ESP32 (经典版)
❌ ESP32-S2 (不支持经典蓝牙)
❌ ESP32-S3 (不支持经典蓝牙)
✅ ESP32-C3 (需要测试)

## 版本信息

- **版本：** 2.0 (模块化版本)
- **日期：** 2024
- **作者：** ESP-AI Team

## 更新日志

### v2.0 (2024) - 模块化重构
- 将单一文件拆分为7个功能模块
- 主程序从414行精简到113行
- 添加userconfig.h集中管理硬件配置
- 提升代码可维护性和可扩展性

### v1.0 (2024) - 初始版本
- 基本的A2DP音箱功能
- I2S音频输出
- 音量控制
- LED状态指示
- 按钮恢复出厂设置

## 联系方式

如有问题或建议，请联系 ESP-AI Team。

