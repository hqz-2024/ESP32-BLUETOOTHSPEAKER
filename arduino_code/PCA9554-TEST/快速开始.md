# PCA9554 IO 变化检测 - 快速开始指南

## 📋 硬件连接

### I2C 连接
```
PCA9554          ESP32
─────────────────────────
VDD      ────→  3.3V
GND      ────→  GND
SDA      ────→  GPIO 4
SCL      ────→  GPIO 15
A2       ────→  GND
A1       ────→  GND
A0       ────→  GND
INT      ────→  GPIO 2
```

### 上拉电阻
- SDA 和 SCL 各需要 4.7kΩ 上拉电阻到 3.3V
- INT 引脚已使用内部上拉

## 🚀 快速开始

### 1. 编译上传
```bash
cd C:\Users\Katasa\Desktop\ESP32-BLUETOOTHSPEAKER\ESP32-BLUETOOTHSPEAKER
pio run -e esp32s3 -t upload
```

### 2. 打开串口监视器
```bash
pio device monitor -b 115200
```

### 3. 测试 IO 变化
- 将 PCA9554 的任意 IO 引脚接地或接 3.3V
- 观察串口输出的变化信息

## 📊 输出说明

### 初始化阶段
```
✅ PCA9554 初始化成功！
   7位地址: 0x38
   8位写地址: 0x70
   8位读地址: 0x71
```

### IO 变化检测
```
🔔 检测到 IO 变化！
IO 状态: 0xFE (0b11111110)

变化的引脚:
  IO0: HIGH → LOW
```

## 🔧 配置修改

### 修改 I2C 引脚
编辑 `PCA9554-TEST.ino` 第 26-28 行：
```cpp
#define I2C_SDA_PIN 4      // 改为你的 SDA 引脚
#define I2C_SCL_PIN 15     // 改为你的 SCL 引脚
#define I2C_FREQ 100000    // I2C 频率
```

### 修改 INT 引脚
编辑 `PCA9554-TEST.ino` 第 34 行：
```cpp
#define INT_PIN 2          // 改为你的 INT 引脚
```

### 修改 PCA9554 地址
编辑 `PCA9554-TEST.ino` 第 31 行：
```cpp
#define PCA9554_ADDR 0x38  // 根据 A2/A1/A0 硬件配置修改
```

## 📍 PCA9554 地址对照表

| A2 | A1 | A0 | 7位地址 | 8位写 | 8位读 |
|----|----|----|--------|-------|-------|
| L  | L  | L  | 0x38   | 0x70  | 0x71  |
| L  | L  | H  | 0x39   | 0x72  | 0x73  |
| L  | H  | L  | 0x3A   | 0x74  | 0x75  |
| L  | H  | H  | 0x3B   | 0x76  | 0x77  |
| H  | L  | L  | 0x3C   | 0x78  | 0x79  |
| H  | L  | H  | 0x3D   | 0x7A  | 0x7B  |
| H  | H  | L  | 0x3E   | 0x7C  | 0x7D  |
| H  | H  | H  | 0x3F   | 0x7E  | 0x7F  |

## ⚠️ 常见问题

### Q: 初始化失败怎么办？
**A:** 检查以下项目：
1. I2C 连接是否正确
2. 上拉电阻是否存在
3. 设备地址是否正确
4. 电源是否正常

### Q: 中断不触发怎么办？
**A:** 检查以下项目：
1. GPIO2 是否连接到 INT 引脚
2. INT 引脚是否有上拉电阻
3. GPIO2 是否被其他功能占用

### Q: 如何修改为部分输入部分输出？
**A:** 修改 `initializePCA9554()` 函数中的 `portMode()` 值：
```cpp
// 例如：IO0-IO3 为输出，IO4-IO7 为输入
ioExpander.portMode(0xF0);  // 1111 0000
```

### Q: 如何设置输出电平？
**A:** 使用 `digitalWrite()` 或 `digitalWritePort()`：
```cpp
// 设置 IO0 为 HIGH
ioExpander.digitalWrite(0, HIGH);

// 设置所有输出为 0x0F
ioExpander.digitalWritePort(0x0F);
```

## 📚 库函数速查

```cpp
// 初始化
ioExpander.begin();

// 配置 IO 模式 (0=输出, 1=输入)
ioExpander.portMode(0xFF);           // 所有 IO 为输入
ioExpander.pinMode(0, INPUT);        // IO0 为输入
ioExpander.pinMode(0, OUTPUT);       // IO0 为输出

// 读取 IO 状态
uint8_t state;
ioExpander.digitalReadPort(state);   // 读取所有 IO
bool pin_state;
ioExpander.digitalRead(0, pin_state); // 读取 IO0

// 写入 IO 状态
ioExpander.digitalWritePort(0x0F);   // 写入所有 IO
ioExpander.digitalWrite(0, HIGH);    // 设置 IO0 为 HIGH

// 极性反转
ioExpander.setPortPolarity(0xFF);    // 反转所有 IO
ioExpander.setPinPolarity(0, true);  // 反转 IO0
```

## 🔗 相关文件

- `PCA9554-TEST.ino` - 主程序
- `README.md` - 详细文档
- `快速开始.md` - 本文件

## 📞 技术支持

如有问题，请检查：
1. 硬件连接是否正确
2. 库文件是否正确安装
3. 串口波特率是否为 115200
4. 地址配置是否正确

---

**提示**：首次使用建议先运行 I2C 扫描程序确认设备地址。

