#include "QMI8658A.h"

QMI8658A imu;

// è“ç‰™éŸ³ç®±æ§åˆ¶ç›¸å…³
bool isPlaying = false;
int currentVolume = 50; // 0-100
unsigned long lastGestureTime = 0;
const unsigned long gestureDebounce = 1000;

// å§¿æ€æ£€æµ‹å‚æ•°
struct GestureThresholds {
    float tiltVolume = 0.4;      // éŸ³é‡æ§åˆ¶å€¾æ–œé˜ˆå€¼
    float shakePlayPause = 1.8;  // æ’­æ”¾æš‚åœæ‘‡æ™ƒé˜ˆå€¼
    float rotateTrack = 80;      // åˆ‡æ­Œæ—‹è½¬é˜ˆå€¼
    float doubleTapPower = 2.5;  // åŒå‡»å¼€å…³æœºé˜ˆå€¼
} thresholds;

void setup() {
    Serial.begin(115200);
    delay(1000);
    
    Serial.println("QMI8658A + Bluetooth Speaker Integration");
    Serial.println("========================================");
    
    // åˆå§‹åŒ–IMU
    if (!initializeIMU()) {
        Serial.println("âŒ IMU initialization failed!");
        while(1) delay(1000);
    }
    
    // åˆå§‹åŒ–è“ç‰™éŸ³ç®± (è¿™é‡Œæ˜¯ç¤ºä¾‹ï¼Œéœ€è¦æ ¹æ®æ‚¨çš„å…·ä½“å®ç°)
    initializeBluetoothSpeaker();
    
    Serial.println("âœ… System ready!");
    printGestureHelp();
}

void loop() {
    if (millis() - lastGestureTime > 50) { // 20Hzæ£€æµ‹é¢‘ç‡
        processGestures();
        lastGestureTime = millis();
    }
    
    // å…¶ä»–è“ç‰™éŸ³ç®±å¤„ç†é€»è¾‘
    delay(10);
}

bool initializeIMU() {
    imu.begin(0x6B);
    
    // é…ç½®ä¼ æ„Ÿå™¨å‚æ•°
    imu.setAccScale(acc_scale_4g);
    imu.setGyroScale(gyro_scale_512dps);
    imu.setAccODR(acc_odr_norm_500);
    imu.setGyroODR(gyro_odr_norm_500);
    imu.setState(sensor_locking);
    
    delay(100);
    
    // éªŒè¯ä¼ æ„Ÿå™¨å·¥ä½œ
    float test_acc = imu.getAccZ();
    return (abs(test_acc) > 0.5 && abs(test_acc) < 2.0); // é‡åŠ›åº”è¯¥æ¥è¿‘1g
}

void initializeBluetoothSpeaker() {
    // è¿™é‡Œæ·»åŠ æ‚¨çš„è“ç‰™éŸ³ç®±åˆå§‹åŒ–ä»£ç 
    Serial.println("ğŸ”µ Bluetooth speaker initialized");
}

void processGestures() {
    static unsigned long lastValidGesture = 0;
    
    if (millis() - lastValidGesture < gestureDebounce) {
        return; // é˜²æŠ–åŠ¨
    }
    
    // è¯»å–ä¼ æ„Ÿå™¨æ•°æ®
    float acc_x = imu.getAccX();
    float acc_y = imu.getAccY();
    float acc_z = imu.getAccZ();
    float gyro_z = imu.getGyroZ();
    
    // 1. éŸ³é‡æ§åˆ¶ (å·¦å³å€¾æ–œ)
    if (detectVolumeGesture(acc_y)) {
        lastValidGesture = millis();
        return;
    }
    
    // 2. æ’­æ”¾/æš‚åœ (æ‘‡æ™ƒ)
    if (detectPlayPauseGesture(acc_x, acc_y, acc_z)) {
        lastValidGesture = millis();
        return;
    }
    
    // 3. åˆ‡æ­Œ (æ—‹è½¬)
    if (detectTrackChangeGesture(gyro_z)) {
        lastValidGesture = millis();
        return;
    }
}

bool detectVolumeGesture(float acc_y) {
    if (abs(acc_y) > thresholds.tiltVolume) {
        if (acc_y > 0) {
            // å³å€¾ - éŸ³é‡å¢åŠ 
            currentVolume = min(100, currentVolume + 5);
            setVolume(currentVolume);
            Serial.printf("ğŸ”Š Volume Up: %d%%\n", currentVolume);
        } else {
            // å·¦å€¾ - éŸ³é‡å‡å°‘
            currentVolume = max(0, currentVolume - 5);
            setVolume(currentVolume);
            Serial.printf("ğŸ”‰ Volume Down: %d%%\n", currentVolume);
        }
        return true;
    }
    return false;
}

bool detectPlayPauseGesture(float acc_x, float acc_y, float acc_z) {
    float magnitude = sqrt(acc_x*acc_x + acc_y*acc_y + acc_z*acc_z);
    
    if (magnitude > thresholds.shakePlayPause) {
        isPlaying = !isPlaying;
        togglePlayPause();
        Serial.printf("â¯ï¸  %s\n", isPlaying ? "Playing" : "Paused");
        return true;
    }
    return false;
}

bool detectTrackChangeGesture(float gyro_z) {
    if (abs(gyro_z) > thresholds.rotateTrack) {
        if (gyro_z > 0) {
            nextTrack();
            Serial.println("â­ï¸  Next Track");
        } else {
            previousTrack();
            Serial.println("â®ï¸  Previous Track");
        }
        return true;
    }
    return false;
}

// è“ç‰™éŸ³ç®±æ§åˆ¶å‡½æ•° (éœ€è¦æ ¹æ®æ‚¨çš„å…·ä½“å®ç°ä¿®æ”¹)
void setVolume(int volume) {
    // å®ç°éŸ³é‡æ§åˆ¶
    Serial.printf("Setting volume to %d%%\n", volume);
}

void togglePlayPause() {
    // å®ç°æ’­æ”¾/æš‚åœåˆ‡æ¢
    Serial.println("Toggling play/pause");
}

void nextTrack() {
    // å®ç°ä¸‹ä¸€é¦–
    Serial.println("Switching to next track");
}

void previousTrack() {
    // å®ç°ä¸Šä¸€é¦–
    Serial.println("Switching to previous track");
}

void printGestureHelp() {
    Serial.println("\nğŸ“± Gesture Controls:");
    Serial.println("   ğŸ”Š Tilt Right  â†’ Volume Up");
    Serial.println("   ğŸ”‰ Tilt Left   â†’ Volume Down");
    Serial.println("   â¯ï¸  Shake       â†’ Play/Pause");
    Serial.println("   â­ï¸  Rotate Right â†’ Next Track");
    Serial.println("   â®ï¸  Rotate Left  â†’ Previous Track");
    Serial.println();
}